# 九 永久失效与黑盒子 ｜ bq4050从上电到PF
如果电池处于一个极端的故障状态，bq4050可以永久停用这个电池组（其实也不算永久，可以连接bqStudio解除）。同时，除了程序存储器和数据存储器的检查失败这两种情况，其他的触发永久失效的条件都可以选择性的打开或关闭。  
如果永久失效状态被触发，bq4050按照以下顺序进行动作：  
1. 关闭充放电和预充电FET  
2. 将OperationStatus寄存器的PF、XDSG、XCHG位置1  
3. 将BatteryStatus的TCA、TDA位置1，高级充电算法返回的电压电流设为0  
4. 将一系列AFE寄存器状态写入DF，包括AFE Interrupt Status, AFE FET Status, AFE RXIN, AFE Latch Status, AFE Interrupt Enable, AFE FET Control, AFE RXIEN, AFE RLOUT, AFE RHOUT, AFE RHINT, AFE Cell Balance, AFE AD/CC Control, AFE ADC Mux, AFE LED Output, AFE State Control, AFE LED/Wake Control, AFE Protection Control, AFE OCD, AFE SCC, AFE SCD1, and AFE SCD2.  
5. 更新黑盒子记录。最后三次引起永久失效触发的SafetyStatus寄存器变化和时间差和最新一次PFStatus寄存器数据一同写入黑盒子记录  
6. 将以下SBS数据保持在DF中以便故障分析：SafetyAlert、SafetyStatus、PFAlert、PFStatus、OperationStatus、ChargingStatus、GaugingStatus、Voltages in DAStatus1、Current、TSINT, TS1, TS2, TS3, and TS4 from DAStatus2、Cell DOD0 and passed charge  
7. 禁止写入DF  
8. 如果发生了特定的故障情况（可设置）并且电池电压还足够烧断电化学熔丝，又或者FET发生故障，那么烧断电化学熔丝  
  
当永久失效触发后，任何新的SafetyAlert、SafetyStatus、PFAlert、PFStatus的位置1都会被记录到永久失效日志中。任何再发生的永久失效事件仍然可以触发电化学熔丝的烧断。相应的，新的PFStatus变化会被记录到黑盒子的第2、3个PF槽位。  
  
## 黑盒子
黑盒子记录组件监视SafetyStatus寄存器并将它最近三次更新的值记录在内存中。一旦出现永久失效触发，就会将最近三次的SafetyStatus寄存器值连同PFStatus寄存器值在触发后的第一至三次变化情况记录到DF中。  
如果发生了不到3次变化，剩余的槽位将会保持为空。  

【本章节尚未完成，请稍后再来看看】  
