# 十 均衡功能、生命历程 ｜ bq4050从上电到PF
## 均衡功能
bq4050实现电池均衡的方法是：通过AFE，在电池外部用电阻旁路一部分通过电池的电流。  
听到这里你可能会有个疑问，我先告诉你答案：没错，bq4050仅支持充电时均衡，对于放电时和静置时均衡无能为力。由于CEDV只能在7%处确定电池的正确容量，所以这也就意味着，不经过7%的RSOC时，无法进行基于容量的均衡，因此无法实现静置时均衡；又因为只有7%的RSOC一处可以用来确定正确容量，而放电到这里没有太大均衡的意义了，因此也不支持放电时均衡。  
因此，完整的说，bq4050通过充电时将一部分电流旁路过某一单节电芯，使得充入这节电芯的电量变少，从而实现电池的均衡操作。  
![](https://bq4050startup.vercel.app/pages/assets/10-1.jpg)  
如图，当电芯电压全部高于Cell Balance Threshold值时，均衡功能启用。bq4050自动检测出电压最高的一节电芯与最低的一节电芯，计算二者电压差值，若超过Cell Balance Min的值，则将最高电压那节电芯的电流旁路，持续Cell Balance Interval值所设定的时间。  
如果任何一节电芯电压高于Cell Balance Threshold的值加上Cell Balance Window（默认为100mV）的值，那么实际使用的Cell Balance Threshold值就会加上Cell Balance Window的值。比如说Cell Balance Threshold=3900mV、Cell Balance Window=100mV，当某一节电芯电压为4.01V时，实际使用的Cell Balance Threshold就会从3900mV变成4000mV。  
均衡功能仅在检测到充电电流的时候才启动。受限于电路结构，相邻的两节电芯无法同时启动均衡。每次充电过程开始时，Threshold值恢复为DF中设定的值，并且仅会增加一次Cell Balance Window的值。  

## 生命历程
bq4050集成了一个日志记录功能，称为Lifetime（生命历程），可通过发送LIFETIME_EN命令启动。  
为了减小DF写入损耗，数据先被收集到RAM中，在以下情况下被更新到DF中：  
- 每10小时，如果生命历程RAM中的数据发生了变化（即被更新，和DF中记录的不同），则更新
- 永久失效发生时，在DF禁止写入之前更新
- 复位计数器增加时（通常意味着发生了复位），此时RAM中数据将丢失而不会更新到DF，但是复位计数是例外，其会被更新到DF中
- 计划性关机时更新（如发送了SHUTDOWN命令）
- 在低电压关机发生前，如果电压还高于Valid Update Voltage则更新（电压过低会导致Flash写入出错）

当发生了以下情况，生命历程数据停止收集：
- 永久失效发生后
- 生命历程功能被关闭

生命历程会记录以下内容：
- 每个电芯的最高/最低电压
- 最大的电芯间电压差
- 最大的瞬时充电/放电电流
- 最大的平均放电电流
- 最大的平均放电功率
- 12种最常见的SafetyStatus状态变化发生的次数，以及最后一次发生该状态时的循环计数
- VCT位置1的次数以及上次置1时的循环计数
- 复位、部分复位、看门狗复位、关机计数
- 每个电芯的累计均衡动作时长（精度为2小时，上限510小时）
- 电芯的最高/最低温度
- （如果设置了多个电池的TS传感器）电池温度差
- 芯片的最高/最低温度
- FET的最高温度
- 总运行时间（精度为2小时）
- 7个温度区间范围内，各温度区间下经历的时长（精度为2小时）
